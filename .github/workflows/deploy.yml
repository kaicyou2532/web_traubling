name: Deploy Next.js to Debian

on:
  push:
    branches:
      - main # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # GitHub Actions ã®å®Ÿè¡Œç’°å¢ƒ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹Node.jsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
          cache: 'npm' # ã¾ãŸã¯ 'yarn'

      - name: Install dependencies
        run: npm ci # ã¾ãŸã¯ yarn install --frozen-lockfile

      - name: Run linters and tests # å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
        # run: |
        #   npm run lint
        #   npm run test

      - name: Build Next.js app
        run: npm run build
        env:
          # ãƒ“ãƒ«ãƒ‰æ™‚ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ã“ã“ã«è¨­å®š
          # ä¾‹: NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NODE_ENV: production

      - name: Prepare SSH key and known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Deploy to Debian server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "ğŸš€ Deploying to server..."
          # ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ã‚µãƒ¼ãƒãƒ¼ã«è»¢é€
          # .next, public, package.json, package-lock.json (ã¾ãŸã¯ yarn.lock) ãªã©ã‚’è»¢é€
          # node_modules ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ npm install --production ã‚’å®Ÿè¡Œã™ã‚‹æ–¹ãŒè‰¯ã„å ´åˆã‚‚ã‚ã‚‹
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            .next \
            public \
            package.json \
            package-lock.json \ # yarnã®å ´åˆã¯yarn.lock
            next.config.js \ # ãã®ä»–å¿…è¦ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/

          echo "ğŸ“¦ Installing production dependencies and restarting app on server..."
          ssh ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "cd ${{ env.DEPLOY_PATH }} && \
            npm install --production && \
            # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åãŒ 'my-nextjs-app' ã®å ´åˆ
            # PM2ã§èµ·å‹•ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ (ä¾‹: pm2 start npm --name "my-nextjs-app" -- run start)
            # ã‚‚ã—ãã¯ã€æ—¢ã«èµ·å‹•ã—ã¦ã„ã‚‹å ´åˆã¯ pm2 restart
            pm2 restart my-nextjs-app || pm2 start npm --name \"my-nextjs-app\" -- run start"
            # (æ³¨æ„) PM2ã®èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®package.jsonã®scriptsã‚„é‹ç”¨ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
            # åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¯ pm2 startã€ä»¥é™ã¯ pm2 restart ã«ãªã‚Šã¾ã™ã€‚
            # `pm2 restart my-nextjs-app || pm2 start ...` ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€
            # å­˜åœ¨ã—ãªã„å ´åˆã¯startã€å­˜åœ¨ã™ã‚‹å ´åˆã¯restartã™ã‚‹ã‚ˆã†ã«ã§ãã¾ã™ã€‚

      - name: Clean up SSH key
        if: always() # æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
        run: |
          rm -f ~/.ssh/id_rsa

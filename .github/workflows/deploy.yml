name: Deploy Next.js to Debian (Dev Mode)

on:
  push:
    branches:
      - main # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ (é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹Node.jsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
          cache: 'npm' # yarnã®å ´åˆã¯ 'yarn'

      - name: Install dependencies
        run: npm install --force # ã“ã“ãŒå¤‰æ›´ç‚¹ã§ã™

      # æ³¨æ„: `npm run dev` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ã“ã®ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã¯ä¸è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
      # `next dev` ã¯é€šå¸¸ã€ç‹¬è‡ªã®ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’è¡Œã†ãŸã‚ã€
      # `next build` ã®æˆæœç‰©ã‚’ç›´æ¥ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚
      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `dev` ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•ä½œã«å¿œã˜ã¦å‰Šé™¤ã¾ãŸã¯èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
      - name: Build Next.js app (Optional for dev mode)
        run: npm run dev
        env:
          # `next dev` ã¯ NODE_ENV=development ã‚’å†…éƒ¨ã§è¨­å®šã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ãŒã€
          # ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—è‡ªä½“ã«æ„å‘³ãŒã‚ã‚‹å ´åˆï¼ˆä¾‹: å‹ãƒã‚§ãƒƒã‚¯ãªã©ï¼‰ã¯æ®‹ã—ã¾ã™ã€‚
          NODE_ENV: production

      - name: Prepare SSH key and known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p $SSH_PORT -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Deploy to Debian server and run in dev mode
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          PM2_APP_NAME: my-nextjs-dev-app # PM2ã§ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã‚’æŒ‡å®š (ä¾‹: my-nextjs-dev-app)
        run: |
          echo "ğŸš€ Deploying to server..."
          # .nextãƒ•ã‚©ãƒ«ãƒ€ã¯ `next dev` ã§ã¯ç›´æ¥ä½¿ã‚ã‚Œãªã„å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ãŒã€
          # `build`ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ®‹ã™å ´åˆã¯è»¢é€å¯¾è±¡ã«å«ã‚ã¦ã„ã¾ã™ã€‚
          # node_moduleså†…ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯è»¢é€ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚
          rsync -avz -e "ssh -p ${{ env.SSH_PORT }}" --delete \
            --exclude '.git' \
            --exclude 'node_modules/.cache' \
            . \ # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è»¢é€ (node_modulesã¯ã‚µãƒ¼ãƒãƒ¼ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/

          echo "ğŸ“¦ Installing dependencies and restarting app in dev mode on server..."
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "cd ${{ env.DEPLOY_PATH }} && \
            npm install && \ # devDependenciesã‚‚å¿…è¦ã«ãªã‚‹ãŸã‚ --production ã¯ä»˜ã‘ã¾ã›ã‚“
            pm2 restart ${{ env.PM2_APP_NAME }} || pm2 start npm --name \"${{ env.PM2_APP_NAME }}\" -- run dev"
            # (æ³¨æ„) package.jsonã« `dev` ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            # ä¾‹: "dev": "next dev" ã‚„ "dev": "next dev -p 3001" ãªã©

      - name: Clean up SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
